This is code base is mostly AI generated. AI Agents (yes I mean you) should follow the designs, requirements and other
guidelines outlined in this document when making changes to the project.

# DM-This

DM-This uses AI to give players a classic D&D like adventure gaming experience using pre-existing adventure modules and
rules provided as PDF documents. Using this source material, DM-This plays the role of DM (Dungeon Master), NPCs
(Non-Player Characters), and other player characters (to fill out a party of adventurers). As the DM, DM-This generates
scene setting visuals and combat battle maps as needed. One or more players can participate in a session via a text chat
style interface and by moving their character tokens on the battle map during combat.

## Overview

DM-This is implemented as a NodeJS service that provides UI via a web browser. 

The project is currently in a prototyping stage. The service only operates a single game session at a time.

The source materials (game rules and adventure modules) are provided as static files in project subdirectories. Game
campaign state is also kept in a project subdirectory.

* **./content/rules/(rule-set-id)/** - contains rule PDFs and data generated by an ingestion process.
* **./content/modules/(module-id)/** - contains module source PDFs and data generated by an ingestion process.
* **./content/campaigns/(campaign-id)/** - contains files that represent current state of a campaign.

Project source code is stored in `./src` folder subdirectories:

* **./src/server** - All server side code. Runs in nodejs.
* **./src/server/agents** - Implements the various LLM agents which interact with players or perform other tasks.
* **./src/server/llm** - Provides API wrappers and utility functions for implementing LLM interactions.
* **./src/server/state** - Embodies the service's data model and runtime state.
* **./src/ui** - All the UI code. Runs in a browser.
* **./src/util** - Server side scripts and utility functions. Mostly python code.
* **./src/util/llm** - LLM API wrappers and utility functions.
* **./src/util/module** - Scripts for processing module content.
* **./src/util/rules** - Scripts for processing rules content.

The `package.json` file supports these commands:

* **npm run dev** - builds everything and starts the service
* **npm run build:client** - builds the `./src/ui` code
* **npm run build:server** - builds the `./src/server` code
* **npm run build** - does `build:client` and `build:server`
* **npm run start** - starts the service

Build output is written to the `./dist/server` and `./dist/ui` directories.

## Setup

Use `npm install` to install all server and client dependencies.

You should also create and activate a python virtual environment and install dependencies using pip:

    python3 -m venv ./venv
    source ./venv/bin/activate
    pip install -r requirements.txt

Once the python venv is setup, you can use `source ./venv/bin/activate` to activate it.

## Configuration

The server and python utility scripts require the following environment variables to be set. It will initialize its
environment from a .env file in the project root, if it exists.

    # API Keys
    ANTHROPIC_API_KEY=(your key goes here)
    OPENAI_API_KEY=(your key goes here)

    # LLM Provider Configuration
    # Options: openai, claude
    DM_THIS_CHAT_LLM=openai

    # Model Configuration
    OPENAI_MODEL=gpt-4o
    CLAUDE_MODEL=claude-3-opus-20240229

    # DM-This directories
    DM_THIS_RULES=./content/rules
    DM_THIS_MODULES=./content/modules
    DM_THIS_CAMPAIGNS=./content/campaigns

    # Campaign loaded by DM-This server
    DM_THIS_CAMPAIGN=SunderedWaves_1

The rule set and module used by the service is identified by the campaign.json file in the campaign subdirectory 
identified by the DM_THIS_CAMPAIGN environment variable.

# Architecture

## Agents

The server implements multiple independent LLM agents, each specialized for a their task:

* **master agent** - this is the primary agent that drives interactions with other agents. The game master is provided the
  PDF(s) from the content/module directory and data from the campaign subdirectory as context. This agent interacts with
  players though a shared chat channel exposed via the web UI. The master agent has four modes of operation (really four
  distinct agents): 
  
    * **Setup** - Character selection/creation, then campaign introduction and initial scene description.
    * **Exploration** - Describing environments and responding to character inputs in relatively unstructured situations.
    * **Encounter** - Describing NPC actions and responding to character actions in a structured turn based situation.
    * **Finished** - Summarizes a campaign upon completion, allows players to ask about encounters or choices not made.

* **rules agent** - the rule agent is provided the PDF(s) from the content/rules subdirectory as context. The master
  agent may direct queries on how the rules apply to specific situations to the rules agent via the rules chat channel.
  Players may ask also ask the rules agent questions in this channel. Recent answers from the rules channel are included
  in the master agent's context.

* **character agent** - These agents play the role of player characters for which no human player is available. An
  independent agent is created for each character. These agents participate in the master chat channel as a player would
  (they observer the actions described by other player and the game master and generate an appropriate response).
  Character agents can also be created by the master agent for prominent recurring NPCs in the campaign, but minor NPCs
  can be role played by the master agent. Character agents are provided with their character sheet as context. This
  document includes the character's stats, as well as background information. The character agent also generates a
  journal containing the character's current state, immediate goals, etc. Old journal entries are summarized and become
  part of the character's background. Recent journal entries are provided to the agent as context.

* **encounter agent** - Supports the master agent when running combat encounters. Keeps track of turns, initiative
  order, and other such details.

* **archive agent** - Maintains campaign and character journals. Monitors the main chat channel to identify game and
character actions that should be recorded. Compresses older journal entries when needed.

### LLM Encapsulation

LLM functionality is encapsulated in an abstraction layer that supports multi-model inputs and outputs and tool use
patterns. The intent of this abstraction layer is to allow different models to be used in the future, as well as for specific
tasks or agents if needed. 

This interface supports prompt/context caching, but the actual implementation for a given LLM may re-upload this data
instead of using server side caching when it is not available.

To work effectively for DM-This, the model should have good PDF support as (currently) these files are uploaded "as is"
and the model must be effective at extracting structured information from these files (e.g. use tables and maps).

## UI

The web UI can be loaded by multiple players. When in `Setup` mode, players can create one or more characters or 
select from pre-made characters. When the game starts (`Exploration` or `Encounter` mode), each player must pick
the character that will be role played through their browser instance.

The web UI presents the player with two primary panels:

* **chat panel** - allows the player to interact with the master and rules agents, as well as with character agents
and/or other player's characters (through their independent browser instance). The chat interface supports images
and text, both as inputs and outputs. Text output can be nicely formatted suing markdown syntax, with images
embedded in the text.

* **map panel** - can be used by the master agent to present a map of the current area. Tokens representing players
and/or NPCs can be positioned on the map. Characters (both player and agent driven) can position their tokens and
the master agent can control the positioning of NPC tokens. A map image, with the positioned tokens, is provided
to in agent contexts.

## Chat Channels

The chat panel supports multiple chat channels. The primary shared "game channel" is used for communication between
characters (agents and player driven) and the master agent. All inputs from any character are sent to all other
characters agents and the master agent. These agents are instructed to provide a response when the input is directed to
them, or if they have an opinion on what is being discussed. Unless directed to another agent, the output of these
agents goes into this shared game channel.

The rules agent can be interacted with via the "rules channel". Master and character agents can direct questions to the
rules channel and analyze the response before taking an action. Players may also select this channel in their ui to ask
questions of the rules agent. Each character agent's or player interaction's with the rules agent are private (no other
character agent or player can see other's questions or responses, especially the master agent which could "spoil"
encounters if seen by players). However, all recent content from the rules channel is included in the master agent's
context, allowing it to use this information when determining the actions it will take when characters take actions.

There are is also a "side channel" where agent and player driven characters can discuss possible actions without them
being entered into the master agent's context. This channel can also be used by a character agent or player to direct
comments to specific characters: each message in this channel has "visibility" flags that determine which characters
see the message and the player or agent can select which visibility flags are set when creating a message.

## Game Modes

### Setup Mode

When a new campaign is started, the master agent will be in "Setup" mode. The master agent will present the player with
a list of pre-created characters extracted from the source module, if there are any. The player may select one of these
characters as a starting point or can describe a character concept to the master agent to have it create a character
based on that concept. The player may iterate on the this character's stats and details (subject to restrictions played
by the master agent based on the module setting and/or rule set being used). The end result of the character creation
process are the character-*.* files, described below, that are written to the campaign directory. This includes a
character sheet file with stats and background information, as well as image files for the character's portrait and map
token.

While in Setup mode, each player interactions with the master agent are private (i.e. each player gets their own "game
channel" and master agent instance.) This allows character creation to be done by multiple players in parallel. When all
players indicate they are ready, the "game channel" becomes shared and the master agent generates an introduction to 
the campaign and sets the opening scene. It may select Exploration or Encounter mode to start the main game loop.

### Exploration Mode

While in this mode, the master agent will describe the current environment and situation for players and accept player
questions and actions as input. The master agent may choose to show a map image, to give players a better idea of their
surroundings. The master agent may also ask the players to position their tokens on this map and this information can
be used to trigger events based on location. Events triggered by player actions can cause the master agent to update 
exploration mode state shared with players, or can cause the master agent to go into Encounter mode.

### Encounter Mode

Encounter mode is similar to exploration mode, but with the addition of keeping track of turns and events that are
triggered on future turns (such as a condition on a character expiring) and a strict ordering of the actions taken by
characters within a turn (i.e. initiative order as defined by the active rule set). Each character's actions during their
turn are also tracked and limited in accordance to the rules (e.g. movement limits, number of attacks allowed, etc.)

### Finished Mode

Once the campaign has finished (as determined by the master agent), this mode allows players to ask about module plot
points where they were confused, or about locations they may not have fully explored, etc. Unlike Exploration and
Encounter modes, where the master agent is instructed to keep secrets from players, in this mode the master agent
is instructed to answer any and all questions about the module for the players.

## Campaign State

All campaign state is kept in files in the `./content/campaigns/(campaign-id)` subdirectory configured for use by the
service. 

### campaign.json

This file contains a JSON format object with the following properties:

- **module** - name of the content/module subdirectory used for this campaign
- **rules** - name of the content/rules subdirectory used for this campaign

### campaign-journal.md

This file is subdivided by campaign day and event, with a final Current Objectives section. For example:

    # Day 1
    ## The Party Meets
    For various reasons, they all ended up in the same common room for dinner. When Rolf and John (NPCs)
    start fighting, Blageron and Forth (players) intervene, holding Rolf and John apart. Simone (player)
    gets Rolf and John to talk, describing what has them riled up. It seems Rolf had promised John some
    help in exploring an old ruin John found nearby. But now Rolf is backing out because he heard there
    were ancient skeletons guarding some tombs there. After some discussion, John agrees to show the 
    party the location of the ruins as long has he gets a cut of anything they find there.
    ## Ambush on the way to the ruins
    As the party nears the ruins, lead by John, they are ambushed by three ... (etc.)
    ## Making camp
    The party makes camp outside the ruins, ready to adventure forth the next day.
    # Day 2
    The party discovers the door that appeared to be an entry way to the ruins is a fake. They search the
    area trying to find another way in. After a while, Blageron notices a strange seam in the rock wall
    near the fake door and is able to pry at it to reveal a hidden entrance.
    (and so on)
    # Current Objectives
    Allow the party to explore the ruins.
    Check for random encounters as described in the module PDF.

### character-stats-(character-name).md

This file is structured as described below. 

    # (character name)
    (character description)
    # Backstory
    (a description of the character's history, motivations, etc.)
    # Stats
    Strength: NN
    etc. (whatever stats the rule system uses)
    # Equipped
    Leather Armor
    Short Sword
    etc. (whatever the character has when starting a campaign)
    # Inventory
    Bedroll
    Rations x 3
    etc. (whatever the character is carrying or otherwise has available for use)

### character-journal-(character-name).md

This file describes the character's actions during the campaign. For agent run characters, it is used to determine what
the character's action will be in a given situation, and records those actions. For player run characters, it is
generated by the archive agent based on the player's chat messages and combat actions, and is used by the master agent
to predict the player's likely response to possible actions. This file is subdivided by day and event and has a final
Current Objectives section just as the campaign-journal.md file is. For example, Blageron's journal could contain:

    # Day 1
    ## A fight over dinner
    While eating dinner in a common room in town, a couple of young townfolk, Rolf and John, get into a fight. Turns
    out John found some ruins and wanted Rolf to go exploring with him but Rolf was scared off by stories of tombs 
    with skeleton guards. Blageron helps calm things down, then decides to go with John to explore the ruins himself. 
    Forth and Simone, who were also in the common room, join up with him and John and set out.
    ## Journey to the ruins
    Blageron and the rest of the party are ambushed near the ruins... (etc.)
    # Current Objectives
    Carefully explore the ruins.
    Make sure our exit path is clear, should we need to escape.

### character-portrait-(character-name).png

A character image either extracted from the module PDF, generated by an agent during the character creation process, or
created and uploaded by the player. This image is shown in the web UI when hovering over a character name in chat
channel ui and the active character selection ui.

### character-token-(character-name).png

A small character image or symbol used to indicate the character's position on a map. Also used as a thumbnail image
next to character names in the UI.